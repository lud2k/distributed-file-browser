!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=6)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.filePreviewSize=t.rootDirName=t.title=t.fileStatPoolSize=t.hosts=t.namespace=t.appName=t.host=t.serverPort=t.directory=t.discoveryMode=t.isDev=void 0,t.isDev="true"===process.env.DEV,t.discoveryMode=process.env.MODE,t.directory=process.env.DIRECTORY||"/var/log",t.serverPort=process.env.SERVER_PORT?parseInt(process.env.SERVER_PORT,10):3e3,t.host=process.env.HOST.includes(":")?process.env.HOST:`${process.env.HOST}:${t.serverPort}`,t.appName=process.env.APP_NAME||"file-browser",t.namespace=process.env.NAMESPACE||"logging",t.hosts=process.env.HOSTS,t.fileStatPoolSize=process.env.FILE_STAT_POOL_SIZE?parseInt(process.env.FILE_STAT_POOL_SIZE,10):25,t.title=process.env.TITLE||"File Browser",t.rootDirName=process.env.ROOT_DIR_NAME||"root",t.filePreviewSize=process.env.FILE_PREVIEW_SIZE?parseInt(process.env.FILE_PREVIEW_SIZE,10):1e5},function(e,t){e.exports=require("path")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.normalizePath=void 0,t.normalizePath=e=>e?e.replace("../",""):""},function(e,t){e.exports=require("request")},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readBytes=t.fileStats=t.fileExists=void 0;const r=o(5);t.fileExists=e=>n(void 0,void 0,void 0,(function*(){return null!==(yield t.fileStats(e))})),t.fileStats=e=>n(void 0,void 0,void 0,(function*(){try{return yield r.promises.stat(e)}catch(e){return null}})),t.readBytes=(e,t,o)=>n(void 0,void 0,void 0,(function*(){const n=yield r.promises.open(e,0),i=o-t,s=Buffer.alloc(i);return yield n.read(s,0,i,t),yield n.close(),s}))},function(e,t){e.exports=require("fs")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(7),r=o(8),i=o(9),s=o(11),c=o(12),a=o(0),u=o(18),d=o(20),l=n();l.get("/local-node",i.localNode),l.get("/cluster-nodes",c.clusterNodes),l.get("/download",r.download),l.get("/watch",u.watch),l.get("/file",d.file),l.get("/",s.index),l.use(n.static("dist")),console.info(`Starting server http://127.0.0.1:${a.serverPort}/`),l.listen(a.serverPort)},function(e,t){e.exports=require("express")},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.download=void 0;const r=o(3),i=o(0),s=o(1),c=o(2);t.download=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const o=c.normalizePath(e.query.path);if(!o)return t.status(404).json({error:"Path not found: "+e.query.path});const n=s.basename(o);if(t.header("Content-Disposition",`attachment; filename="${n}"`),e.query.host){const n=encodeURIComponent(o);r(`http://${e.query.host}/download?path=${n}`).pipe(t)}else t.sendFile(o,{root:i.directory})}catch(e){console.error("Error downloading file",e),t.status(500).json({error:"Oops! Something went wrong: "+e})}}))},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.localNode=void 0;const r=o(5),i=o(1),s=o(0),c=o(10),a=o(2),u=o(4),d=(e,t)=>({path:e.substr(s.directory.length+1),name:i.basename(e),type:"file",modifiedAt:t.mtimeMs,createdAt:t.ctimeMs,size:t.size,host:s.host}),l=(e,t)=>({path:e.substr(s.directory.length+1),name:i.basename(e),type:"directory",modifiedAt:t.mtimeMs,createdAt:t.ctimeMs,size:t.size,host:s.host});t.localNode=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const f=a.normalizePath(e.query.path),p=i.join(s.directory,f),v=yield u.fileStats(p);if(!v)return void t.status(404).json({error:"Path not found: "+f});if(v.isFile())t.json({node:d(p,v)});else if(v.isDirectory()){const e=l(p,v);e.nodes=yield(o=p,n(void 0,void 0,void 0,(function*(){const e=yield r.promises.readdir(o);return(yield c.default(s.fileStatPoolSize,e,e=>n(void 0,void 0,void 0,(function*(){const t=i.join(o,e),n=yield r.promises.stat(t);return n.isDirectory()?l(t,n):n.isFile()?d(t,n):void 0})))).filter(e=>e)}))),t.json({node:e})}else t.status(400).json({error:"Unsupported path: "+f})}catch(e){console.error("Error getting local node",e),t.status(500).json({error:e})}var o}))},function(e,t){e.exports=require("tiny-async-pool")},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.index=void 0;const r=o(0);t.index=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const e=r.isDev?"http://localhost:9000/frontend.js":"frontend.js",o={rootDirName:r.rootDirName,filePreviewSize:r.filePreviewSize};t.send(`\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset="UTF-8" />\n          <title>${r.title}</title>\n          <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />\n          <script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.13.1/umd/react.production.min.js"><\/script>\n          <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.13.1/umd/react-dom.production.min.js"><\/script>\n        </head>\n        <body>\n          <script type="application/javascript">\n            window.config = ${JSON.stringify(o)};\n          <\/script>\n          <script src="${e}"><\/script>\n        </body>\n      </html>\n      `)}catch(e){console.error("Error rendering index",e),t.send("Error rendering index: "+e)}}))},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.clusterNodes=t.getNodesFromHost=void 0;const r=o(13),i=o(14),s=o(2);t.getNodesFromHost=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const o=encodeURIComponent(t),n=yield r.default(`http://${e}/local-node?path=${o}`);if(200===n.status){return(yield n.json()).node}if(404!==n.status)return new Error(`Request to ${e} failed with status ${n.status}`)}catch(t){return new Error(`Request to ${e} failed with error ${t.message}`)}})),t.clusterNodes=(e,o)=>n(void 0,void 0,void 0,(function*(){try{const n=s.normalizePath(e.query.path),r=yield i.getHosts(),c=yield Promise.all(r.map(e=>t.getNodesFromHost(e,n))),a=c.filter(e=>e&&!(e instanceof Error)),u=c.filter(e=>e instanceof Error).map(e=>e.message);o.json({nodes:a,errors:u})}catch(e){console.error("Error getting cluster nodes",e),o.json({error:e.message})}}))},function(e,t){e.exports=require("node-fetch")},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getHosts=void 0;const r=o(0),i=o(15),s=o(17);t.getHosts=()=>n(void 0,void 0,void 0,(function*(){if("kubernetes"===r.discoveryMode)return i.getHosts();if("ips"===r.discoveryMode)return s.getHosts();throw new Error("Unknown discovery mode: "+r.discoveryMode)}))},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getHosts=void 0;const r=o(16),i=o(0),s=new r.KubeConfig;s.loadFromDefault();const c=s.makeApiClient(r.CoreV1Api);t.getHosts=()=>n(void 0,void 0,void 0,(function*(){return(yield c.listNamespacedPod(i.namespace,void 0,void 0,void 0,void 0,"name="+i.appName)).body.items.filter(e=>{var t;return"Running"===(null===(t=e.status)||void 0===t?void 0:t.phase)}).map(e=>`${e.status.podIP}:${i.serverPort}`)}))},function(e,t){e.exports=require("@kubernetes/client-node")},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getHosts=void 0;const r=o(0);t.getHosts=()=>n(void 0,void 0,void 0,(function*(){return r.hosts.split(",")}))},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.watch=void 0;const r=o(1),i=o(3),s=o(0),c=o(19),a=o(4),u=o(2);t.watch=(e,t)=>n(void 0,void 0,void 0,(function*(){try{if(e.query.host){console.info("Watch proxy started: "+e.query.path);const o=encodeURIComponent(e.query.path),n=encodeURIComponent(e.query.from),r=i(`http://${e.query.host}/watch?path=${o}&from=${n}`),s=r.pipe(t),c=()=>{console.info("Watch proxy ended: "+e.query.path),r.abort(),r.end(),s.end(),t.end()};r.on("close",c),r.on("end",c),e.on("close",c),e.on("end",c)}else{const o=u.normalizePath(e.query.path),n=r.join(s.directory,o),i=yield a.fileStats(n);if(!i)return void t.status(404).json({error:"Path not found: "+e.query.path});const d=Math.max(0,parseInt(e.query.from,10)),l=yield a.readBytes(n,d,i.size);t.write(l),console.info("Watch started: "+n);let f=new c.Tail(n);f.on("line",e=>{t.write(e+"\n",e=>{e&&f.unwatch()})});const p=()=>{console.info("Watch ended: "+n),f&&(f.unwatch(),f=null)};f.on("error",e=>{t.write(`Tailing failed: ${e}\n`),t.end(),p()}),e.on("close",p),e.on("end",p),f.watch()}}catch(e){console.error("Error watching file",e),t.status(500).json({error:"Oops! Something went wrong: "+e})}}))},function(e,t){e.exports=require("tail")},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.file=void 0;const r=o(1),i=o(3),s=o(0),c=o(4);t.file=(e,t)=>n(void 0,void 0,void 0,(function*(){try{if(e.query.host){const o=encodeURIComponent(e.query.path);i(`http://${e.query.host}/file?path=${o}&from=${e.query.from}&to=${e.query.to}`).pipe(t)}else{const o=r.join(s.directory,e.query.path),n=yield c.fileStats(o);if(!n)return void t.status(404).json({error:"Path not found: "+e.query.path});const i=Math.max(parseInt(e.query.from,10),0),a=Math.min(parseInt(e.query.to,10),n.size),u=yield c.readBytes(o,i,a);t.header("File-From",i.toString()),t.header("File-To",a.toString()),t.header("File-Size",n.size.toString()),t.end(u)}}catch(e){console.error("Error reading file",e),t.status(500).json({error:"Oops! Something went wrong: "+e})}}))}]);